---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getAllBlogPosts, getBlogPost } from '../../../lib/api/blog';
import { marked } from 'marked';
import '../../../styles/markdown.css';

export async function getStaticPaths() {
  try {
    const posts = await getAllBlogPosts();

    // Return all blog post slugs for static generation
    return posts.map((post) => ({
      params: { slug: post.slug },
      props: { post },
    }));
  } catch (error) {
    console.warn('[getStaticPaths] Failed to fetch blog posts:', error);
    // Return empty array - pages will be generated on-demand or via ISR
    return [];
  }
}

const { slug } = Astro.params;
const { post: preloadedPost } = Astro.props;

// Try to use preloaded post, otherwise fetch
let post = preloadedPost;
if (!post && slug) {
  post = await getBlogPost(slug);
}

if (!post || !slug) {
  return Astro.redirect('/ressources/blog');
}

const title = post.seoTitle || post.title;
const description = post.seoDescription || post.description;

// Convert markdown content to HTML
const htmlContent = marked.parse(post.content);
---

<BaseLayout title={`${title} | Blog ImmoTopia`} description={description} currentPath={`/ressources/blog/${slug}`}>
  <article class="bg-white">
    <!-- Breadcrumbs -->
    <div class="border-b border-gray-200 bg-gray-50 py-4">
      <div class="container mx-auto max-w-7xl px-6">
        <nav class="flex items-center gap-2 text-sm text-gray-600">
          <a href="/" class="hover:text-[#2563EB]">Accueil</a>
          <span>/</span>
          <a href="/ressources/blog" class="hover:text-[#2563EB]">Blog</a>
          <span>/</span>
          <span class="text-gray-900">{post.title}</span>
        </nav>
      </div>
    </div>

    <!-- Article Header -->
    <header class="border-b border-gray-200 bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 py-16">
      <div class="container mx-auto max-w-4xl px-6">
        {post.category && (
          <span class="inline-block mb-4 text-xs font-semibold text-[#2563EB] uppercase tracking-wider">
            {post.category}
          </span>
        )}
        <h1 class="mb-4 text-4xl font-extrabold text-gray-900 md:text-5xl">
          {post.title}
        </h1>
        {post.description && (
          <p class="mb-6 text-xl text-gray-700">
            {post.description}
          </p>
        )}
        <div class="flex items-center gap-4 text-sm text-gray-600">
          <span>{new Date(post.date).toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
          {post.author && <span>Par {post.author}</span>}
          {post.readingTime > 0 && <span>{post.readingTime} min de lecture</span>}
        </div>
      </div>
    </header>

    <!-- Article Content -->
    <div class="py-12 md:py-20">
      <div class="container mx-auto max-w-4xl px-6">
        {post.coverImage && (
          <img 
            src={post.coverImage} 
            alt={post.title} 
            class="w-full h-auto rounded-lg mb-8"
            loading="eager"
            decoding="async"
            width="1200"
            height="600"
          />
        )}
        <div class="prose prose-lg max-w-none">
          <div set:html={htmlContent} />
        </div>
      </div>
    </div>
  </article>
</BaseLayout>

